name: Enhance Release PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
      - aot_monorepo_compat

permissions:
  contents: write
  pull-requests: write
  issues: write
  id-token: write

jobs:
  enhance-release-pr:
    name: ü§ñ Claude AI Enhancement
    if: startsWith(github.head_ref, 'release-please--')
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout PR Branch
        uses: actions/checkout@v5
        with:
          ref: ${{ github.head_ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üè∑Ô∏è Extract Version from PR Title
        id: version
        run: |
          VERSION=$(echo "${{ github.event.pull_request.title }}" | grep -oP '\d+\.\d+\.\d+' || echo "")
          if [ -z "$VERSION" ]; then
            echo "‚ö†Ô∏è Could not extract version from PR title"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "üì¶ Detected version: $VERSION"
          fi

      - name: ‚¨ÖÔ∏è Get Previous Version
        id: prev_version
        if: steps.version.outputs.skip != 'true'
        run: |
          PREV=$(cat .release-please-manifest.json | grep -oP '"\.: "\K[^"]+' || echo "0.0.0")
          echo "prev_version=$PREV" >> $GITHUB_OUTPUT
          echo "üì¶ Previous version: $PREV"

      - name: ‚úÖ Check if Already Enhanced
        id: check
        if: steps.version.outputs.skip != 'true'
        run: |
          if grep -q "### üöÄ Release Highlights" CHANGELOG.md; then
            VERSION_LINE=$(grep -n "## \[${{ steps.version.outputs.version }}\]" CHANGELOG.md | head -1 | cut -d: -f1 || echo "0")
            HIGHLIGHTS_LINE=$(grep -n "### üöÄ Release Highlights" CHANGELOG.md | head -1 | cut -d: -f1 || echo "99999")
            
            if [ "$VERSION_LINE" != "0" ] && [ "$HIGHLIGHTS_LINE" -gt "$VERSION_LINE" ]; then
              NEXT_VERSION=$(grep -n "## \[" CHANGELOG.md | grep -v "^$VERSION_LINE:" | head -1 | cut -d: -f1 || echo "99999")
              if [ "$HIGHLIGHTS_LINE" -lt "${NEXT_VERSION:-99999}" ]; then
                echo "‚úÖ Already enhanced"
                echo "already_enhanced=true" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi
          fi
          echo "already_enhanced=false" >> $GITHUB_OUTPUT

      - name: ü§ñ Full Release Enhancement with Claude
        if: steps.version.outputs.skip != 'true' && steps.check.outputs.already_enhanced != 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY_GLOBAL_CLOUD_RUNTIME }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PROPOSED_VERSION: ${{ steps.version.outputs.version }}
            PREVIOUS_VERSION: ${{ steps.prev_version.outputs.prev_version }}
            PR_BRANCH: ${{ github.head_ref }}
            PR_NUMBER: ${{ github.event.pull_request.number }}
            
            # ü§ñ CLAUDE CODE: RELEASE MANAGER FOR open-runtime/grpc-dart
            
            ## Project Context
            
            This is a **FORK** of grpc/grpc-dart with critical production enhancements:
            - **Race condition fixes** - Prevents "Cannot add event after closing" crashes
            - **Null connection fix** - Actionable errors instead of null pointer exceptions
            - **ServerInterceptor support** - Powers the AOT security architecture
            
            Key files: `lib/src/server/handler.dart`, `lib/src/client/http2_connection.dart`
            
            Release Please has proposed version **${{ steps.version.outputs.version }}** (from ${{ steps.prev_version.outputs.prev_version }}).
            
            ---
            
            ## üéØ YOUR MISSION: Complete Pre-Release Enhancement
            
            Execute these tasks IN ORDER:
            
            ---
            
            ## TASK 0: üî¢ VERSION REVIEW (CRITICAL - DO THIS FIRST!)
            
            ```bash
            git log v${{ steps.prev_version.outputs.prev_version }}..HEAD --oneline
            ```
            
            **Version Rules:**
            | Change Type | Version | Examples |
            |-------------|---------|----------|
            | **MAJOR** | X.0.0 | Removing public API, breaking protocol changes |
            | **MINOR** | x.Y.0 | New features, upstream merge with new capabilities |
            | **PATCH** | x.y.Z | Bug fixes, docs, CI, race condition fixes |
            
            **‚ö†Ô∏è BREAKING CHANGE Rules (IMPORTANT!):**
            
            Only use MAJOR bump for **actual API breaking changes**:
            - ‚úÖ Removing or renaming public classes/methods
            - ‚úÖ Changing method signatures
            - ‚úÖ Protocol incompatibilities
            
            **NEVER** MAJOR for:
            - ‚ùå Workflow/CI changes
            - ‚ùå Documentation updates
            - ‚ùå Internal refactoring
            - ‚ùå Adding new features (that's MINOR)
            
            **If version is wrong** (e.g., 6.0.0 for docs changes):
            1. Update `.release-please-manifest.json` to correct version
            2. Update `pubspec.yaml` version field
            3. Update CHANGELOG.md version header
            4. Commit: `fix: Adjust version to X.Y.Z (from proposed A.B.C)`
            
            ---
            
            ## TASK 1: üìù ADD RELEASE HIGHLIGHTS
            
            Insert after version header in CHANGELOG.md:
            
            ```markdown
            ### üöÄ Release Highlights
            
            [2-4 sentences about DEVELOPER IMPACT, not implementation details]
            ```
            
            **‚úÖ GOOD Example:**
            ```markdown
            ### üöÄ Release Highlights
            
            This release adds automated release management with AI-enhanced notes, making version
            tracking effortless. The fork's critical race condition fixes remain fully intact,
            ensuring production stability for high-concurrency gRPC servers.
            ```
            
            **‚ùå BAD Example:**
            ```markdown
            ### üöÄ Release Highlights
            
            Various improvements and bug fixes. Updated CI workflows and some internal changes.
            Please update when convenient.
            ```
            
            Commit: `docs: Add AI-enhanced release highlights for v${{ steps.version.outputs.version }}`
            
            ---
            
            ## TASK 2: üìö DOCUMENTATION SYNC
            
            Check if these need updates:
            - `README.md` - Installation instructions, version references
            - `WHY_USE_OPEN_RUNTIME_FORK.md` - If fork-specific features changed
            - `FORK_CHANGES.md` - If new fixes were added
            - `CLAUDE.md` - If conventions changed
            
            **Only update if genuinely needed.** Don't change for the sake of it.
            
            ---
            
            ## TASK 3: üè∑Ô∏è ISSUE MANAGEMENT
            
            ```bash
            gh issue list --repo ${{ github.repository }} --state open --limit 50
            ```
            
            **When to CLOSE an issue:**
            - Commit explicitly says "Fixes #X" or "Closes #X"
            - You can verify the fix by reading code changes
            - Issue description matches what was changed
            
            **When NOT to close:**
            - Partially addressed (comment with progress instead)
            - Not 100% certain it's fixed
            - Feature request needing user verification
            
            **Closing comment format:**
            ```
            üéâ This issue has been addressed in v${{ steps.version.outputs.version }}!
            The fix will be available once the release PR merges.
            ```
            
            ---
            
            ## TASK 4: üí¨ POST PR SUMMARY
            
            ```bash
            gh pr comment ${{ github.event.pull_request.number }} --body "## üöÄ Release v[VERSION] Ready!
            
            ### Version Review:
            - **Proposed:** ${{ steps.version.outputs.version }}
            - **Final:** [ACTUAL_VERSION] ‚úÖ
            - **Reason:** [Why this version is correct]
            
            ### What Claude Did:
            - [x] Reviewed version appropriateness
            - [x] Added Release Highlights to CHANGELOG.md
            - [x] Reviewed documentation (updates: yes/no)
            - [x] Processed related issues (N found)
            
            ### Fork-Specific Notes:
            [Notes about upstream compatibility, critical fixes preserved, etc.]
            
            ### Installation (after merge):
            \\\`\\\`\\\`yaml
            dependencies:
              grpc:
                git:
                  url: https://github.com/open-runtime/grpc-dart
                  tag_pattern: \"^v\"
                version: ^[VERSION]
            \\\`\\\`\\\`
            
            **Ready to merge!** üéâ
            
            ---
            *ü§ñ Generated by Claude Code Action*"
            ```
            
            ---
            
            ## EXECUTION RULES
            
            1. **Git Setup First:**
               ```bash
               git config user.name "github-actions[bot]"
               git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
               ```
            
            2. **Commit Each Change Separately** with conventional commit messages
            
            3. **Push All Changes:**
               ```bash
               git push origin ${{ github.head_ref }}
               ```
            
            4. **Be Conservative** - this is a critical infrastructure package
            
            Now execute all tasks in order!
          claude_args: |
            --allowedTools "Read,Edit,Bash(git:*),Bash(gh:*),Bash(cat:*),Bash(head:*),Bash(grep:*)"

      - name: ‚ÑπÔ∏è Already Enhanced Notice
        if: steps.check.outputs.already_enhanced == 'true'
        run: |
          echo "‚ÑπÔ∏è Release PR already enhanced - skipping"

