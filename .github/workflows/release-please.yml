# =============================================================================
# Release Please Workflow for open-runtime/grpc-dart Fork
# =============================================================================
# Automates releases using Conventional Commits:
#   - feat: â†’ Minor version bump
#   - fix:  â†’ Patch version bump
#   - feat!/fix!/BREAKING CHANGE: â†’ Major version bump
#
# Flow:
#   1. Creates/updates a Release PR when conventional commits land
#   2. Claude enhances the PR (via enhance-release-pr.yml)
#   3. When merged: Creates tag and GitHub Release
#   4. Dart packages can consume via tag_pattern: "^v"
# =============================================================================

name: Release Please

on:
  push:
    branches:
      - main
      - aot_monorepo_compat

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write

jobs:
  release-please:
    name: ðŸ“¦ Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      releases_created: ${{ steps.release.outputs.releases_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}
      sha: ${{ steps.release.outputs.sha }}
      pr: ${{ steps.release.outputs.pr }}
      prs_created: ${{ steps.release.outputs.prs_created }}
    steps:
      - name: ðŸ“¥ Checkout source code
        uses: actions/checkout@v4

      - name: ðŸ¤– Run Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json
          target-branch: ${{ github.ref_name }}

      - name: ðŸ“ Log Release Info
        if: ${{ steps.release.outputs.releases_created == 'true' }}
        run: |
          echo "ðŸŽ‰ Release created!"
          echo "ðŸ“¦ Version: ${{ steps.release.outputs.version }}"
          echo "ðŸ·ï¸ Tag: ${{ steps.release.outputs.tag_name }}"
          echo "ðŸ”— https://github.com/${{ github.repository }}/releases/tag/${{ steps.release.outputs.tag_name }}"

  # =============================================================================
  # Fallback: Handle Untagged Merged Release PRs
  # =============================================================================
  # If Release Please aborts due to "untagged merged release PRs", this job
  # will find those PRs, create the missing tags, and create GitHub releases.
  # This handles edge cases like when Claude changes the version in a Release PR.
  # =============================================================================
  handle-untagged-releases:
    name: ðŸ”§ Handle Untagged Releases (Fallback)
    needs: release-please
    # Run if Release Please didn't create a release (might have aborted)
    if: ${{ needs.release-please.outputs.releases_created != 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Find and process untagged merged release PRs
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Checking for untagged merged release PRs..."
          
          # Find merged PRs with autorelease: pending label
          PENDING_PRS=$(gh pr list --repo ${{ github.repository }} \
            --state merged \
            --label "autorelease: pending" \
            --json number,title,mergeCommit \
            --jq '.[] | select(.title | test("^chore: release "))')
          
          if [ -z "$PENDING_PRS" ]; then
            echo "âœ… No untagged merged release PRs found"
            exit 0
          fi
          
          echo "ðŸ“‹ Found untagged release PRs:"
          echo "$PENDING_PRS"
          
          # Process each pending PR
          echo "$PENDING_PRS" | jq -c '.' | while read -r pr; do
            PR_NUM=$(echo "$pr" | jq -r '.number')
            PR_TITLE=$(echo "$pr" | jq -r '.title')
            MERGE_SHA=$(echo "$pr" | jq -r '.mergeCommit.oid')
            
            # Extract version from title "chore: release X.Y.Z"
            VERSION=$(echo "$PR_TITLE" | grep -oP '\d+\.\d+\.\d+')
            
            if [ -z "$VERSION" ]; then
              echo "âš ï¸ Could not extract version from PR #$PR_NUM title: $PR_TITLE"
              continue
            fi
            
            TAG_NAME="v$VERSION"
            echo "ðŸ“¦ Processing PR #$PR_NUM: $PR_TITLE"
            echo "   Version: $VERSION"
            echo "   SHA: $MERGE_SHA"
            echo "   Tag: $TAG_NAME"
            
            # Check if tag already exists
            if gh api repos/${{ github.repository }}/git/refs/tags/$TAG_NAME 2>/dev/null; then
              echo "âœ… Tag $TAG_NAME already exists"
            else
              echo "ðŸ·ï¸ Creating tag $TAG_NAME at $MERGE_SHA"
              gh api repos/${{ github.repository }}/git/refs \
                -X POST \
                -f ref="refs/tags/$TAG_NAME" \
                -f sha="$MERGE_SHA"
            fi
            
            # Check if release already exists
            if gh release view $TAG_NAME --repo ${{ github.repository }} 2>/dev/null; then
              echo "âœ… Release $TAG_NAME already exists"
            else
              echo "ðŸŽ‰ Creating GitHub Release $TAG_NAME"
              
              # Extract changelog for this version
              CHANGELOG=$(awk -v ver="$VERSION" '
                /^## \[/ {
                  if (found) exit
                  if ($0 ~ "## \\[" ver "\\]") found=1
                }
                found { print }
              ' CHANGELOG.md | tail -n +2)
              
              if [ -z "$CHANGELOG" ]; then
                CHANGELOG="Release v$VERSION - See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for details."
              fi
              
              # Create the release
              gh release create $TAG_NAME \
                --repo ${{ github.repository }} \
                --title "v$VERSION" \
                --notes "## ðŸ“¦ Installation

**Dart 3.9+ (recommended):**
\`\`\`yaml
dependencies:
  grpc:
    git:
      url: https://github.com/open-runtime/grpc-dart
      tag_pattern: \"^v\"
    version: ^$VERSION
\`\`\`

**Direct tag reference:**
\`\`\`yaml
dependencies:
  grpc:
    git:
      url: https://github.com/open-runtime/grpc-dart
      ref: v$VERSION
\`\`\`

---

$CHANGELOG"
            fi
            
            # Update label to autorelease: tagged
            echo "ðŸ·ï¸ Updating PR #$PR_NUM label to autorelease: tagged"
            gh pr edit $PR_NUM \
              --repo ${{ github.repository }} \
              --remove-label "autorelease: pending" \
              --add-label "autorelease: tagged" || true
            
            echo "âœ… Processed PR #$PR_NUM"
          done

  # =============================================================================
  # Verify Release
  # =============================================================================
  verify-release:
    name: âœ… Verify Release
    needs: release-please
    if: ${{ needs.release-please.outputs.releases_created == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout source code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.release-please.outputs.tag_name }}

      - name: ðŸŽ¯ Install Dart SDK
        uses: dart-lang/setup-dart@v1
        with:
          sdk: stable

      - name: ðŸ“š Get dependencies
        run: dart pub get

      - name: ðŸ” Verify package
        run: |
          echo "ðŸ“¦ Verifying package version..."
          VERSION=$(grep '^version:' pubspec.yaml | awk '{print $2}')
          EXPECTED="${{ needs.release-please.outputs.version }}"
          if [ "$VERSION" != "$EXPECTED" ]; then
            echo "âŒ Version mismatch: pubspec.yaml has $VERSION, expected $EXPECTED"
            exit 1
          fi
          echo "âœ… Version verified: $VERSION"

      - name: ðŸ§¹ Run analysis
        run: dart analyze --fatal-infos .

      - name: ðŸ§ª Run tests
        run: dart test --platform vm

      - name: ðŸ“‹ Release Summary
        run: |
          echo "## ðŸŽ‰ Release v${{ needs.release-please.outputs.version }} Verified!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Installation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Dart 3.9+ with tag_pattern (recommended):**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "dependencies:" >> $GITHUB_STEP_SUMMARY
          echo "  grpc:" >> $GITHUB_STEP_SUMMARY
          echo "    git:" >> $GITHUB_STEP_SUMMARY
          echo "      url: https://github.com/open-runtime/grpc-dart" >> $GITHUB_STEP_SUMMARY
          echo "      tag_pattern: \"^v\"" >> $GITHUB_STEP_SUMMARY
          echo "    version: ^${{ needs.release-please.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”— Links" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/v${{ needs.release-please.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- [Changelog](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md)" >> $GITHUB_STEP_SUMMARY
